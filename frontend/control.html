<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sonos Control</title>
</head>
<body>
  <h1>Sonos Control</h1>
  <div id="status">Loading...</div>

  <div id="householdSection" style="display:none;">
    <label for="householdSelect">Select Household:</label>
    <select id="householdSelect"></select>
  </div>

  <div id="groupSection" style="display:none;">
    <label for="groupSelect">Select Group:</label>
    <select id="groupSelect"></select>
  </div>

  <div id="playersSection" style="display:none;">
    <h3>Players in Group</h3>
    <ul id="playersList"></ul>
    <button id="playBtn">Play</button>
    <button id="pauseBtn">Pause</button>
    <button id="nextBtn">Next</button>
  </div>

  <script>
    const MIN_FIRMWARE = "64.10";
    const token = localStorage.getItem("sonos_access_token");
    const expires = localStorage.getItem("sonos_access_token_expires");

    // Token check
    if (!token || Date.now() > expires) {
      alert("Your Sonos session expired. Please log in again.");
      localStorage.removeItem("sonos_access_token");
      localStorage.removeItem("sonos_access_token_expires");
      window.location.href = "/index.html";
    }

    const statusEl = document.getElementById("status");
    const householdSelect = document.getElementById("householdSelect");
    const groupSelect = document.getElementById("groupSelect");
    const playersList = document.getElementById("playersList");
    const playBtn = document.getElementById("playBtn");
    const pauseBtn = document.getElementById("pauseBtn");
    const nextBtn = document.getElementById("nextBtn");

    function versionToArray(v) {
      return v.split('.').map(Number);
    }

    function compareVersions(a, b) {
      const [aMajor, aMinor] = versionToArray(a);
      const [bMajor, bMinor] = versionToArray(b);
      if (aMajor !== bMajor) return aMajor - bMajor;
      return aMinor - bMinor;
    }

    async function fetchJson(url) {
      const res = await fetch(url, {
        headers: { "Authorization": `Bearer ${token}`, "Accept": "application/json" }
      });
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    async function getHouseholds() {
      const data = await fetchJson("https://api.ws.sonos.com/control/api/v1/households");
      return data.households || [];
    }

    async function getGroups(householdId) {
      const data = await fetchJson(`https://api.ws.sonos.com/control/api/v1/households/${householdId}/groups`);
      return data.groups || [];
    }

    async function getPlayers(playerIds) {
      const promises = playerIds.map(id =>
        fetchJson(`https://api.ws.sonos.com/control/api/v1/players/${id}`)
      );
      return Promise.all(promises);
    }

    function populateSelect(selectEl, items, valueKey="id", textKey="name") {
      selectEl.innerHTML = "";
      items.forEach(item => {
        const opt = document.createElement("option");
        opt.value = item[valueKey];
        opt.textContent = item[textKey];
        selectEl.appendChild(opt);
      });
    }

    async function init() {
      try {
        statusEl.textContent = "Fetching households...";
        const households = await getHouseholds();
        if (!households.length) {
          statusEl.textContent = "No households found.";
          return;
        }
        populateSelect(householdSelect, households);
        document.getElementById("householdSection").style.display = "block";
        await loadGroups(householdSelect.value);
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Failed to fetch households.";
      }
    }

    let currentGroups = [];

    async function loadGroups(householdId) {
      try {
        statusEl.textContent = "Fetching groups...";
        currentGroups = await getGroups(householdId);
        if (!currentGroups.length) {
          statusEl.textContent = "No groups found.";
          return;
        }
        populateSelect(groupSelect, currentGroups);
        document.getElementById("groupSection").style.display = "block";
        await loadPlayers(groupSelect.value);
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Failed to fetch groups.";
      }
    }

    async function loadPlayers(groupId) {
      try {
        statusEl.textContent = "Fetching players...";
        const selectedGroup = currentGroups.find(g => g.id === groupId);
        if (!selectedGroup) {
          statusEl.textContent = "Group not found.";
          return;
        }

        const players = await getPlayers(selectedGroup.playerIds);
        playersList.innerHTML = "";

        let allSupported = true;
        players.forEach(player => {
          const li = document.createElement("li");
          li.textContent = `${player.name} â€” Firmware: ${player.firmwareVersion}`;
          playersList.appendChild(li);

          if (compareVersions(player.firmwareVersion, MIN_FIRMWARE) < 0) {
            allSupported = false;
          }
        });

        // playBtn.disabled = pauseBtn.disabled = nextBtn.disabled = !allSupported;
        // statusEl.textContent = allSupported 
        //   ? "Ready to control Sonos groups." 
        //   : "Some players do not meet minimum firmware version!";
        statusEl.textContent = "Ready to control Sonos groups.";

        document.getElementById("playersSection").style.display = "block";
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Failed to fetch players.";
      }
    }

    householdSelect.addEventListener("change", () => loadGroups(householdSelect.value));
    groupSelect.addEventListener("change", () => loadPlayers(groupSelect.value));

    async function sendCommand(action) {
      const groupId = groupSelect.value;
      if (!groupId) return statusEl.textContent = "Select a group first.";

      try {
        statusEl.textContent = `Sending '${action}' command...`;
        const res = await fetch(`https://api.ws.sonos.com/control/api/v1/groups/${groupId}/playback/${action}`, {
          method: "POST",
          headers: { "Authorization": `Bearer ${token}`, "Accept": "application/json" }
        });

        if (!res.ok) throw new Error(await res.text());
        statusEl.textContent = `Command '${action}' sent successfully.`;
      } catch (err) {
        console.error(err);
        statusEl.textContent = `Failed to send '${action}' command.`;
      }
    }

    playBtn.addEventListener("click", () => sendCommand("play"));
    pauseBtn.addEventListener("click", () => sendCommand("pause"));
    nextBtn.addEventListener("click", () => sendCommand("skipToNextTrack"));

    init();
  </script>
</body>
</html>
