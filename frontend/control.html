<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sonos Control</title>
</head>
<body>
  <h1>Sonos Control</h1>
  <div id="status">Loading...</div>

  <div id="householdSection" style="display:none;">
    <label for="householdSelect">Select Household:</label>
    <select id="householdSelect"></select>
  </div>

  <div id="groupSection" style="display:none;">
    <label for="groupSelect">Select Group:</label>
    <select id="groupSelect"></select>
  </div>

  <div id="playersSection" style="display:none;">
    <h3>Players in Group</h3>
    <ul id="playersList"></ul>
    <button id="playBtn">Play</button>
    <button id="pauseBtn">Pause</button>
    <button id="nextBtn">Next</button>
  </div>

  <script>
    const MIN_FIRMWARE = "64.10"; // example minimum version
    const token = localStorage.getItem("sonos_access_token");
    const expires = localStorage.getItem("sonos_access_token_expires");

    if (!token || Date.now() > expires) {
      alert("Your Sonos session expired. Please log in again.");
      localStorage.removeItem("sonos_access_token");
      localStorage.removeItem("sonos_access_token_expires");
      window.location.href = "/index.html";
    }

    const statusEl = document.getElementById("status");
    const householdSelect = document.getElementById("householdSelect");
    const groupSelect = document.getElementById("groupSelect");
    const playersList = document.getElementById("playersList");
    const playBtn = document.getElementById("playBtn");
    const pauseBtn = document.getElementById("pauseBtn");
    const nextBtn = document.getElementById("nextBtn");

    async function getHouseholds() {
      const res = await fetch("https://api.ws.sonos.com/control/api/v1/households", {
        headers: { "Authorization": `Bearer ${token}`, "accept": "application/json" }
      });
      const data = await res.json();
      return data.households || [];
    }

    async function getGroups(householdId) {
      const res = await fetch(`https://api.ws.sonos.com/control/api/v1/households/${householdId}/groups`, {
        headers: { "Authorization": `Bearer ${token}`, "accept": "application/json" }
      });
      const data = await res.json();
      return data.groups || [];
    }

    async function getPlayers(playerIds) {
      // Fetch info for each player
      const promises = playerIds.map(id =>
        fetch(`https://api.ws.sonos.com/control/api/v1/players/${id}`, {
          headers: { "Authorization": `Bearer ${token}`, "accept": "application/json" }
        }).then(res => res.json())
      );
      return Promise.all(promises);
    }

    function populateSelect(selectEl, items, valueKey="id", textKey="name") {
      selectEl.innerHTML = "";
      items.forEach(item => {
        const opt = document.createElement("option");
        opt.value = item[valueKey];
        opt.textContent = item[textKey];
        selectEl.appendChild(opt);
      });
    }

    async function init() {
      statusEl.textContent = "Fetching households...";
      const households = await getHouseholds();
      if (!households.length) {
        statusEl.textContent = "No households found.";
        return;
      }

      populateSelect(householdSelect, households);
      document.getElementById("householdSection").style.display = "block";

      await loadGroups(householdSelect.value);
    }

    async function loadGroups(householdId) {
      statusEl.textContent = "Fetching groups...";
      const groups = await getGroups(householdId);
      if (!groups.length) {
        statusEl.textContent = "No groups found.";
        return;
      }

      populateSelect(groupSelect, groups);
      document.getElementById("groupSection").style.display = "block";
      await loadPlayers(groupSelect.value);
    }

    async function loadPlayers(groupId) {
      statusEl.textContent = "Fetching players...";
      const selectedGroup = (await getGroups(householdSelect.value)).find(g => g.id === groupId);
      if (!selectedGroup) return;

      const players = await getPlayers(selectedGroup.playerIds);
      playersList.innerHTML = "";

      let allSupported = true;
      players.forEach(player => {
        const li = document.createElement("li");
        li.textContent = `${player.name} â€” Firmware: ${player.firmwareVersion}`;
        playersList.appendChild(li);

        if (player.firmwareVersion < MIN_FIRMWARE) {
          allSupported = false;
        }
      });

      if (!allSupported) {
        playBtn.disabled = pauseBtn.disabled = nextBtn.disabled = true;
        statusEl.textContent = "Some players do not meet minimum firmware version!";
      } else {
        playBtn.disabled = pauseBtn.disabled = nextBtn.disabled = false;
        statusEl.textContent = "Ready to control Sonos groups.";
      }

      document.getElementById("playersSection").style.display = "block";
    }

    householdSelect.addEventListener("change", () => loadGroups(householdSelect.value));
    groupSelect.addEventListener("change", () => loadPlayers(groupSelect.value));

    async function sendCommand(action) {
      const groupId = groupSelect.value;
      if (!groupId) return alert("Select a group first.");

      const url = `https://api.ws.sonos.com/control/api/v1/groups/${groupId}/playback/${action}`;
      try {
        const res = await fetch(url, {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${token}`,
            "accept": "application/json"
          }
        });

        if (res.ok) alert(`Command '${action}' sent successfully.`);
        else alert(`Error: ${await res.text()}`);
      } catch (err) {
        console.error(err);
        alert("Failed to send command.");
      }
    }

    playBtn.addEventListener("click", () => sendCommand("play"));
    pauseBtn.addEventListener("click", () => sendCommand("pause"));
    nextBtn.addEventListener("click", () => sendCommand("skipToNextTrack"));

    init();
  </script>
</body>
</html>
