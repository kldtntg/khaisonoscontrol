<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Sonos Control</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #f5f6fa;
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        min-height: 100vh;
      }

      .container {
        background: #fff;
        padding: 2rem;
        margin-top: 2rem;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        max-width: 600px;
        width: 100%;
        text-align: center;
      }

      h1 {
        margin-bottom: 1rem;
        color: #2c3e50;
      }

      #status {
        margin-bottom: 1.5rem;
        font-style: italic;
        color: #555;
      }

      select {
        padding: 0.5rem;
        border-radius: 6px;
        border: 1px solid #ccc;
        margin: 0.5rem 0;
        font-size: 1rem;
      }

      .section {
        margin: 1.5rem 0;
      }

      #nowPlayingSection {
        border-top: 1px solid #eee;
        padding-top: 1rem;
      }

      #nowPlayingText {
        font-size: 1.1rem;
        margin: 0.5rem 0;
        color: #333;
      }

      #nowPlayingImage {
        margin-top: 0.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      }

      .controls button {
        padding: 0.7rem 1.2rem;
        margin: 0.3rem;
        border: none;
        border-radius: 8px;
        background: #3498db;
        color: #fff;
        font-size: 1rem;
        cursor: pointer;
        transition: background 0.2s ease;
      }

      .controls button:hover {
        background: #2980b9;
      }

      .controls button:active {
        background: #1c5980;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Sonos Control</h1>
      <div id="status">Loading...</div>

      <div id="householdSection" class="section" style="display: none">
        <label for="householdSelect">Select Household:</label>
        <br />
        <select id="householdSelect"></select>
      </div>

      <div id="groupSection" class="section" style="display: none">
        <label for="groupSelect">Select Group:</label>
        <br />
        <select id="groupSelect"></select>
      </div>

      <div id="nowPlayingSection" class="section" style="display: none">
        <h3>Now Playing</h3>
        <div id="nowPlayingText"></div>
        <img
          id="nowPlayingImage"
          src=""
          alt="Now Playing Art"
          style="max-width: 200px; display: none"
        />
      </div>

      <div id="playersSection" class="section controls" style="display: none">
        <h3>Commands</h3>
        <button id="prevBtn">⏮ Previous</button>
        <button id="playBtn">▶ Play</button>
        <button id="pauseBtn">⏸ Pause</button>
        <button id="nextBtn">⏭ Next</button>
      </div>
    </div>

    <script>
      const statusEl = document.getElementById("status");
      const householdSelect = document.getElementById("householdSelect");
      const groupSelect = document.getElementById("groupSelect");
      const playBtn = document.getElementById("playBtn");
      const pauseBtn = document.getElementById("pauseBtn");
      const nextBtn = document.getElementById("nextBtn");
      const prevBtn = document.getElementById("prevBtn");

      // Backend proxy fetch (no token needed)
      async function apiFetch(path, options = {}) {
        const res = await fetch(`${window.location.origin}${path}`, options);
        if (!res.ok) throw new Error(await res.text());
        return res.json();
      }

      function populateSelect(selectEl, items) {
        selectEl.innerHTML = "";
        items.forEach((item) => {
          const opt = document.createElement("option");
          opt.value = item.id;
          opt.textContent = item.id;
          selectEl.appendChild(opt);
        });
      }

      async function loadHouseholds() {
        try {
          statusEl.textContent = "Fetching households...";
          const data = await apiFetch("/api/households");
          const households = data.households || [];
          if (!households.length) {
            statusEl.textContent = "No households found.";
            return;
          }
          populateSelect(householdSelect, households);
          document.getElementById("householdSection").style.display = "block";
          loadGroups(householdSelect.value);
        } catch (err) {
          console.error(err);
          statusEl.textContent = "Failed to fetch households.";
          window.location.href = "/";
        }
      }

      async function loadGroups(householdId) {
        try {
          statusEl.textContent = "Fetching groups...";
          const data = await apiFetch(`/api/groups/${householdId}`);
          const groups = data.groups || [];
          if (!groups.length) {
            statusEl.textContent = "No groups found.";
            return;
          }
          populateSelect(groupSelect, groups);
          document.getElementById("groupSection").style.display = "block";
          document.getElementById("playersSection").style.display = "block";
          statusEl.textContent = "Ready to control Sonos group.";
        } catch (err) {
          console.error(err);
          statusEl.textContent = "Failed to fetch groups.";
        }
      }

      async function sendCommand(action) {
        try {
          const groupId = groupSelect.value;
          if (!groupId) return alert("Select a group first.");
          await apiFetch(`/api/groups/${groupId}/playback/${action}`, {
            method: "POST",
          });
        } catch (err) {
          console.error(err);
          alert("Failed to send command: " + err.message);
        }
      }

      // Event listeners
      householdSelect.addEventListener("change", () =>
        loadGroups(householdSelect.value)
      );
      playBtn.addEventListener("click", () => sendCommand("play"));
      pauseBtn.addEventListener("click", () => sendCommand("pause"));
      nextBtn.addEventListener("click", () => sendCommand("skipToNextTrack"));
      prevBtn.addEventListener("click", () => sendCommand("skipToPreviousTrack"));

      // Initialize
      loadHouseholds();

      const nowPlayingSection = document.getElementById("nowPlayingSection");
      const nowPlayingText = document.getElementById("nowPlayingText");
      const nowPlayingImage = document.getElementById("nowPlayingImage");

      // Fetch and display current track
      async function loadNowPlaying() {
        const groupId = groupSelect.value;
        if (!groupId) return;

        try {
          const data = await apiFetch(`/api/groups/${groupId}/nowPlaying`);

          if (!data.trackName && !data.streamInfo) {
            nowPlayingText.textContent = "Nothing is playing.";
            nowPlayingImage.style.display = "none";
          } else {
            nowPlayingText.textContent = data.trackName
              ? `${data.artist?.name || "Unknown Artist"} - ${data.trackName} (${
                  data.album?.name || "Unknown Album"
                })`
              : data.streamInfo || "Playing unknown content";

            if (data.imageUrl) {
              nowPlayingImage.src = data.imageUrl;
              nowPlayingImage.style.display = "block";
            } else {
              nowPlayingImage.style.display = "none";
            }
          }

          nowPlayingSection.style.display = "block";
        } catch (err) {
          console.error(err);
          nowPlayingText.textContent = "Failed to load now playing info.";
        }
      }

      // Poll every 2 seconds
      setInterval(loadNowPlaying, 2000);

      // load immediately when group changes
      groupSelect.addEventListener("change", () => {
        loadGroups(groupSelect.value);
        loadNowPlaying();
      });
    </script>
  </body>
</html>
